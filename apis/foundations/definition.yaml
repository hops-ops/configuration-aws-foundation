apiVersion: apiextensions.crossplane.io/v2
kind: CompositeResourceDefinition
metadata:
  name: foundations.aws.hops.ops.com.ai
spec:
  scope: Namespaced
  group: aws.hops.ops.com.ai
  names:
    kind: Foundation
    plural: foundations
  versions:
  - name: v1alpha1
    served: true
    referenceable: true
    schema:
      openAPIV3Schema:
        type: object
        description: |
          Foundation creates a complete AWS foundation: Organization with accounts,
          Identity Center with permission sets, and IPAM for network IP management.
          Accounts can be referenced by name throughout the configuration.
        required:
        - spec
        properties:
          spec:
            type: object
            required:
            - managementPolicies
            properties:
              managementPolicies:
                type: array
                description: ManagementPolicies for all composed resources.
                items:
                  type: string
                  enum: ["*", Create, Observe, Update, Delete, LateInitialize]
                default: ["*"]

              providerConfigRef:
                type: object
                description: AWS provider config reference. Falls back to metadata.name.
                properties:
                  name:
                    type: string
                    description: Provider config name.
                  kind:
                    type: string
                    description: Provider config kind.
                    default: ProviderConfig

              kubernetesProviderConfigRef:
                type: object
                description: Kubernetes provider config reference. Falls back to metadata.name.
                properties:
                  name:
                    type: string
                    description: Provider config name.
                  kind:
                    type: string
                    description: Provider config kind.
                    default: ProviderConfig

              region:
                type: string
                description: Default AWS region for resources that require it.

              memberAccountsProviderConfigs:
                type: object
                description: |
                  Configuration for creating AWS ProviderConfigs for each member account.
                  Uses Kubernetes Object resources to manage cluster-scoped ProviderConfigs.
                properties:
                  enabled:
                    type: boolean
                    description: Enable creation of ProviderConfigs for member accounts. Defaults to true.
                    default: true
                  managementPolicies:
                    type: array
                    description: |
                      ManagementPolicies for the Kubernetes Object resources that create ProviderConfigs.
                      Defaults to ["*"]. Set explicitly for e2e testing scenarios.
                    items:
                      type: string
                      enum: ["*", Create, Observe, Update, Delete, LateInitialize]
                    default: ["*"]
                  namespace:
                    type: string
                    description: Namespace where the member account ProviderConfigs will be created. Defaults to "default".
                    default: "default"

              tags:
                type: object
                description: Default tags applied to all AWS resources.
                x-kubernetes-preserve-unknown-fields: true

              # =============================================================================
              # Organization - passed to aws-organization XRD
              # =============================================================================
              organization:
                type: object
                description: AWS Organization configuration. Passed to Organization XRD.
                x-kubernetes-preserve-unknown-fields: true

              organizationalUnits:
                type: array
                description: |
                  Organizational unit hierarchy using path-based definition.
                  Each OU can contain nested accounts. Passed to Organization XRD.
                items:
                  type: object
                  required:
                  - path
                  x-kubernetes-preserve-unknown-fields: true
                  properties:
                    path:
                      type: string
                      description: OU path (e.g., Security, Workloads/Prod).
                      pattern: ^[a-zA-Z0-9-]+(/[a-zA-Z0-9-]+)*$

              accounts:
                type: array
                description: |
                  AWS accounts to create. Each account is placed in an OU and can be
                  referenced by name in permission sets and delegated administrators.
                items:
                  type: object
                  required:
                  - name
                  - email
                  x-kubernetes-preserve-unknown-fields: true
                  properties:
                    name:
                      type: string
                      description: |
                        Logical account name. Used as reference key everywhere.
                        Also becomes metadata.name for the Account composite.
                    email:
                      type: string
                      description: AWS account email (must be unique globally).
                    ou:
                      type: string
                      description: |
                        OU path where account will be placed (e.g., Workloads/Prod).
                        Must match a path in organizationalUnits.

              delegatedAdministrators:
                type: array
                description: Delegated administrator accounts for AWS services.
                items:
                  type: object
                  required:
                  - servicePrincipal
                  - account
                  x-kubernetes-preserve-unknown-fields: true
                  properties:
                    servicePrincipal:
                      type: string
                      description: AWS service principal (e.g., sso.amazonaws.com).
                    account:
                      type: string
                      description: Account name from spec.accounts[].name.

              # =============================================================================
              # Identity Center - passed to aws-identity-center XRD
              # =============================================================================
              identityCenter:
                type: object
                description: AWS IAM Identity Center configuration. Passed to IdentityCenter XRD.
                x-kubernetes-preserve-unknown-fields: true
                properties:
                  enabled:
                    type: boolean
                    description: Enable Identity Center. Defaults to true if identityStoreId is set.
                  region:
                    type: string
                    description: AWS region for Identity Center.
                  identityStoreId:
                    type: string
                    description: Identity Store ID (required when enabled).
                  providerConfig:
                    type: string
                    description: Override AWS provider config for Identity Center.
                  instanceArn:
                    type: string
                    description: Existing Identity Center instance ARN.
                  sessionDuration:
                    type: string
                    description: Default session duration (ISO8601). Defaults to PT1H.
                  groups:
                    type: array
                    description: Identity Store groups. Passed to IdentityCenter XRD.
                    items:
                      type: object
                      required:
                      - name
                      x-kubernetes-preserve-unknown-fields: true
                      properties:
                        name:
                          type: string
                          description: Group name for reference in permission sets.
                  users:
                    type: array
                    description: Identity Store users. Passed to IdentityCenter XRD.
                    items:
                      type: object
                      required:
                      - username
                      x-kubernetes-preserve-unknown-fields: true
                      properties:
                        username:
                          type: string
                          description: Username for reference.
                        groups:
                          type: array
                          description: Group names this user belongs to.
                          items:
                            type: string
                  permissionSets:
                    type: array
                    description: |
                      Permission sets with account assignments.
                      assignToAccounts uses account names (resolved to IDs by Foundation).
                    items:
                      type: object
                      required:
                      - name
                      x-kubernetes-preserve-unknown-fields: true
                      properties:
                        name:
                          type: string
                          description: Permission set name.
                        assignToAccounts:
                          type: array
                          description: |
                            Account names from spec.accounts[].name.
                            Foundation resolves these to account IDs.
                          items:
                            type: string
                        assignToGroups:
                          type: array
                          description: Group names to assign this permission set to.
                          items:
                            type: string
                        assignToUsers:
                          type: array
                          description: Local user names to assign this permission set to.
                          items:
                            type: string

              # =============================================================================
              # IPAM - passed to aws-ipam XRD
              # =============================================================================
              ipam:
                type: object
                description: |
                  AWS VPC IP Address Manager configuration. Passed directly to IPAM XRD.
                  Pool structure matches the IPAM API: pools.ipv4[], pools.ipv6.gua[], pools.ipv6.ula[].
                x-kubernetes-preserve-unknown-fields: true
                properties:
                  enabled:
                    type: boolean
                    description: Enable IPAM. Defaults to true if pools are defined.
                  providerConfig:
                    type: string
                    description: Override AWS provider config for IPAM.
                  region:
                    type: string
                    description: AWS region hosting the IPAM instance.
                  operatingRegions:
                    type: array
                    description: AWS regions where IPAM can allocate CIDRs.
                    items:
                      type: string
                  externalName:
                    type: string
                    description: |
                      IPAM ID to adopt (e.g., ipam-0123456789abcdef0).
                      When set, imports the existing IPAM instead of creating a new one.
                  forProvider:
                    type: object
                    description: Override any forProvider field on the VPCIpam resource.
                    x-kubernetes-preserve-unknown-fields: true
                  managementPolicies:
                    type: array
                    description: |
                      ManagementPolicies for the IPAM. Overrides spec.managementPolicies if set.
                    items:
                      type: string
                      enum:
                      - "*"
                      - Create
                      - Observe
                      - Update
                      - Delete
                      - LateInitialize
                  pools:
                    type: object
                    description: |
                      IPAM pools organized by type. Structure matches IPAM XRD directly.
                    properties:
                      ipv4:
                        type: array
                        description: IPv4 pools for private address allocation.
                        items:
                          type: object
                          required:
                          - name
                          x-kubernetes-preserve-unknown-fields: true
                          properties:
                            name:
                              type: string
                              description: Pool name for reference.
                      ipv6:
                        type: object
                        description: IPv6 pools organized by type.
                        properties:
                          gua:
                            type: array
                            description: Global Unicast Address pools (Amazon-provided, internet-routable).
                            items:
                              type: object
                              required:
                              - name
                              x-kubernetes-preserve-unknown-fields: true
                              properties:
                                name:
                                  type: string
                                  description: Pool name for reference.
                          ula:
                            type: array
                            description: Unique Local Address pools (private, not internet-routable).
                            items:
                              type: object
                              required:
                              - name
                              x-kubernetes-preserve-unknown-fields: true
                              properties:
                                name:
                                  type: string
                                  description: Pool name for reference.

              # =============================================================================
              # Network Defaults - inherited by all networks
              # =============================================================================
              networkDefaults:
                type: object
                description: |
                  Default settings inherited by all networks. Deep merged with
                  network-specific values (explicit values win).
                properties:
                  subnetLayout:
                    type: object
                    description: Default subnet layout for all networks.
                    x-kubernetes-preserve-unknown-fields: true
                    properties:
                      availabilityZones:
                        type: array
                        description: Default AZ suffixes (e.g., ["a", "b", "c"]).
                        items:
                          type: string
                        default: [a, b, c]
                      public:
                        type: object
                        properties:
                          enabled:
                            type: boolean
                            default: true
                          netmaskLength:
                            type: integer
                            default: 24
                      private:
                        type: object
                        properties:
                          enabled:
                            type: boolean
                            default: true
                          netmaskLength:
                            type: integer
                            default: 20
                  nat:
                    type: object
                    description: Default NAT configuration for all networks.
                    properties:
                      enabled:
                        type: boolean
                        default: true
                      strategy:
                        type: string
                        enum: [SingleAz, HighlyAvailable, None]
                        default: SingleAz
                  flowLogs:
                    type: object
                    description: Default flow logs configuration.
                    x-kubernetes-preserve-unknown-fields: true
                  tags:
                    type: object
                    description: Default tags merged with spec.tags for all networks.
                    x-kubernetes-preserve-unknown-fields: true

              # =============================================================================
              # Networks - VPCs deployed to accounts
              # =============================================================================
              networks:
                type: array
                description: |
                  VPC networks to create. Each network creates an aws-network Network instance.
                  When account is specified, uses that account's ProviderConfig.
                  When account is omitted, uses spec.providerConfigRef (management account).
                items:
                  type: object
                  required:
                  - name
                  - region
                  properties:
                    name:
                      type: string
                      description: |
                        Network name. Becomes the Network metadata.name.
                        Also used as resource name prefix.
                    account:
                      type: string
                      description: |
                        Account name from spec.accounts[].name.
                        Resolves to ProviderConfig for that account.
                        Omit to use management account (spec.providerConfigRef).
                    region:
                      type: string
                      description: AWS region for this network.

                    # IPAM allocation
                    ipam:
                      type: object
                      description: IPAM-based CIDR allocation.
                      properties:
                        ipv4:
                          type: object
                          properties:
                            poolRef:
                              type: string
                              description: |
                                Pool name from spec.ipam.pools.ipv4[].name.
                                Resolved to pool ID from IPAM status.
                            poolId:
                              type: string
                              description: |
                                Direct pool ID (ipam-pool-xxx). Use when pool
                                is external to this Foundation.
                            netmaskLength:
                              type: integer
                              description: Netmask length for VPC CIDR.
                              default: 16
                        ipv6Ula:
                          type: object
                          properties:
                            poolRef:
                              type: string
                              description: Pool name from spec.ipam.pools.ipv6.ula[].name.
                            poolId:
                              type: string
                              description: Direct pool ID for external pools.
                            netmaskLength:
                              type: integer
                              default: 56

                    # Manual VPC CIDR (alternative to IPAM)
                    vpc:
                      type: object
                      description: VPC configuration with manual CIDR.
                      x-kubernetes-preserve-unknown-fields: true
                      properties:
                        cidr:
                          type: string
                          description: IPv4 CIDR block for the VPC.

                    # Subnet layout (merged with networkDefaults.subnetLayout)
                    subnetLayout:
                      type: object
                      description: Subnet layout overrides for this network.
                      x-kubernetes-preserve-unknown-fields: true

                    # NAT (merged with networkDefaults.nat)
                    nat:
                      type: object
                      description: NAT Gateway configuration overrides.
                      x-kubernetes-preserve-unknown-fields: true

                    # Internet Gateway
                    internetGateway:
                      type: object
                      description: Internet Gateway configuration (for import support).
                      x-kubernetes-preserve-unknown-fields: true

                    # Egress-Only Internet Gateway
                    egressOnlyInternetGateway:
                      type: object
                      description: Egress-only IGW configuration for IPv6 (for import support).
                      x-kubernetes-preserve-unknown-fields: true

                    # Route Tables
                    routeTables:
                      type: object
                      description: Route table configuration (for import support).
                      x-kubernetes-preserve-unknown-fields: true

                    # Transit Gateway attachment
                    transitGateway:
                      type: object
                      description: Transit Gateway attachment configuration.
                      x-kubernetes-preserve-unknown-fields: true
                      properties:
                        enabled:
                          type: boolean
                          default: false
                        config:
                          type: object
                          properties:
                            tgwId:
                              type: string
                              description: Existing Transit Gateway ID.

                    # Flow logs
                    flowLogs:
                      type: object
                      description: VPC Flow Logs configuration overrides.
                      x-kubernetes-preserve-unknown-fields: true

                    # Network-specific tags
                    tags:
                      type: object
                      description: |
                        Network-specific tags. Merged with spec.tags and
                        networkDefaults.tags (later wins).
                      x-kubernetes-preserve-unknown-fields: true

                    # Management policies override
                    managementPolicies:
                      type: array
                      description: Override management policies for this network.
                      items:
                        type: string
                        enum: ["*", Create, Observe, Update, Delete, LateInitialize]

          status:
            type: object
            description: Observed state for Foundation.
            x-kubernetes-preserve-unknown-fields: true
            properties:
              ready:
                type: boolean
                description: All components are ready.
              organization:
                type: object
                x-kubernetes-preserve-unknown-fields: true
              organizationalUnits:
                type: object
                description: Map of OU paths to OU IDs.
                x-kubernetes-preserve-unknown-fields: true
              accounts:
                type: array
                description: Accounts with their resolved IDs and ProviderConfig info.
                items:
                  type: object
                  x-kubernetes-preserve-unknown-fields: true
              identityCenter:
                type: object
                x-kubernetes-preserve-unknown-fields: true
              ipam:
                type: object
                x-kubernetes-preserve-unknown-fields: true
              networks:
                type: array
                description: Network status with VPC IDs and subnet info.
                items:
                  type: object
                  properties:
                    name:
                      type: string
                    account:
                      type: string
                      description: Account name (or "management" if none specified).
                    region:
                      type: string
                    ready:
                      type: boolean
                    vpcId:
                      type: string
                    cidr:
                      type: object
                      properties:
                        ipv4:
                          type: string
                        ipv6Ula:
                          type: string
                    subnets:
                      type: object
                      x-kubernetes-preserve-unknown-fields: true
              spec:
                type: object
                description: |
                  Debugging output showing raw input vs effective config.
                  Helps identify where defaults are applied or misconfigurations exist.
                x-kubernetes-preserve-unknown-fields: true
                properties:
                  raw:
                    type: object
                    description: User's original spec (before defaults applied).
                    x-kubernetes-preserve-unknown-fields: true
                  effective:
                    type: object
                    description: Spec with all defaults applied (what templates actually use).
                    x-kubernetes-preserve-unknown-fields: true
